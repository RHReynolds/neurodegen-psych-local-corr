---
title: "Running univariate and bivariate LAVA"
author: 
- name: "Aaron Wagen & Regina H. Reynolds"
  affiliation: UCL
output: 
  bookdown::html_document2:
    figure_caption: yes
    code_folding: hide
    theme: paper
    highlight: kate
    df_print: paged
    toc: true
    toc_float: true
    number_sections: true
---

```{r setup, include = FALSE}

library(circlize) # For chord diagram
library(ggplot2) # For plotting
library(ggraph) # For edge diagrams
library(janitor) # For cleaning dirty data
library(tidyverse) # For tidy manipulation of data
library(stringr) # For string manipulation
library(rtracklayer) # For loading of reference gtf

knitr::opts_chunk$set(echo = T, warning = F, message = F)

# Set defaults for ggplots 
theme_rhr <- 
  theme_bw(base_family = "Helvetica",
           base_size = 10) + 
  theme(panel.grid.major.x = element_blank(),
        legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
        axis.title.y = element_text(vjust = 0.6),
        panel.spacing = unit(0.1, "lines"))

loci <- LAVA::read.loci(here::here("results", "01_input_prep", "gwas_filtered.loci"))
fct_disease <- c("AD", "LBD", "PD", "BIP", "MDD", "SCZ")

```

> Aim: run univariate and bivariate tests
<br><br>

# Background

Neurodegenerative diseases are often defined by the predominant neuropathology (e.g. synucleinopathies by $\alpha$-synuclein deposition), but more often than not, they also present with co-pathologies, suggesting that they might share common pathogenic pathways (PMID: [29878075](https://pubmed.ncbi.nlm.nih.gov/29878075/), [30258235](https://pubmed.ncbi.nlm.nih.gov/30258235/)). This notion is supported by genetic studies, which have (i) identified shared risk loci across neurodegenerative disorders, such as APOE and BIN1 in Alzheimer’s disease (AD) and Lewy body dementia (LBD), or GBA, SNCA, TMEM175 in Parkinson’s disease (PD) and LBD and (ii) demonstrated that genetic risk scores derived from one neurodegenerative disorder can predict risk of another, as with AD and PD predicting risk of LBD (PMID: [31701892](https://pubmed.ncbi.nlm.nih.gov/31701892/), [30953760](https://pubmed.ncbi.nlm.nih.gov/30953760/), [33589841](https://pubmed.ncbi.nlm.nih.gov/33589841/)).

From a clinical perspective, neurodegenerative diseases are often also defined in terms of their predominant cognitive and/or motor symptoms (e.g. Alzheimer's disease by cognitive and memory impairment or Parkinson's disease by parkinsonism), but in reality, present as highly heterogenous diseases, with symptoms spanning multiple domains, including neurospychiatric symptoms (PMID: [27188934](https://pubmed.ncbi.nlm.nih.gov/27188934/), [28332488](https://pubmed.ncbi.nlm.nih.gov/28332488/). Indeed, a higher prevalence of depression has been observed in individuals with dementia compared to those without dementia (PMID: [30536144](https://pubmed.ncbi.nlm.nih.gov/30536144/)). Notably, a similar (albeit reversed) phenomenon has been observed in some neuropsychiatric disorders, with a higher risk of dementia diagnoses observed in individuals with schizophrenia (SCZ) versus individuals without a history of serious mental illness (PMID: [33688938](https://pubmed.ncbi.nlm.nih.gov/33688938/), [26444987](https://pubmed.ncbi.nlm.nih.gov/26444987/)).

These clinical and/or pathological overlaps are not, however, always reflected in terms of global genetic correlations, with a recent study of global genetic correlation between neurological phenotypes demonstrating limited overlap between individual neurodegenerative disorders as well as between neurodegenerative and neuropsychiatric disorders (PMID: [29930110](https://pubmed.ncbi.nlm.nih.gov/29930110/)). One explanation for this is that global studies only consider an average across the entire genome, and thus, may fail to detect correlations confined to particular genomic regions, or where changes are balanced out over the genome. This limitation has recently been addressed with the development of Local analysis of [co]variant annotation (LAVA), which is able to evaluate local heritability over multiple traits of interest (using GWAS summary statistics) and detect local regions of shared genetic association (https://www.biorxiv.org/content/10.1101/2020.12.31.424652v2). Here, we apply LAVA to genome-wide association studies (GWASs) derived from three neurodenerative disorders (AD, PMID: [30617256](https://pubmed.ncbi.nlm.nih.gov/30617256/);LBD, PMID: [33589841](https://pubmed.ncbi.nlm.nih.gov/33589841/); and PD, PMID: [31701892](https://pubmed.ncbi.nlm.nih.gov/31701892/)), and three neuropsychiatric disorders (bipolar disorder, BIP, PMID: [34002096](https://pubmed.ncbi.nlm.nih.gov/34002096/); major depressive disorder, MDD, PMID: [30718901](https://pubmed.ncbi.nlm.nih.gov/30718901/); and SCZ, PMID: [29483656](https://pubmed.ncbi.nlm.nih.gov/29483656/)).

# Supplementary code {.tabset}

Following section includes any intermediary code used in this `.Rmd`.

## Run univariate and bivariate tests
This can either be sourced directly:

```{r run-univar-bivar, eval = F}

source(here::here("scripts", "02_run_univar_bivar_test.R"))

```

Alternatively, for many phenotypes/loci it can be worth running this script directly on the cluster, using `nohup`, as performed below:

```{bash bash-run-univar-bivar, eval = F}
# Have to navigate to root project folder for script to work (as it uses here package)
cd /home/rreynolds/misc_projects/neurodegen-psych-local-corr

nohup Rscript \
/home/rreynolds/misc_projects/neurodegen-psych-local-corr/scripts/02_run_univar_bivar_test.R \
&>/home/rreynolds/misc_projects/neurodegen-psych-local-corr/logs/02_run_univar_bivar_test.log&

```


## Loading results
Once run, results can be loaded using the following code chunk:

```{r load-lava-results}
files <- 
  list.files(
  path = 
    here::here("results",
               "02_univar_bivar_test"),
  pattern = ".lava.rds", 
  full.names = T
)

results <- 
  setNames(
    object = files %>% 
      lapply(., function(file){
        
        list <- 
          file %>% 
          readRDS() 
        
        list %>% 
          purrr::discard(is.null) %>% 
          qdapTools::list_df2df() %>% 
          dplyr::select(-X1)
        
      }),
    nm = files %>% 
      basename() %>% 
      str_remove(".lava.rds") %>% 
      str_remove(".*:") %>% 
      str_remove(".*\\.")
  )

```

```{r load-ldsc}
global <- 
  read_delim(
    file = here::here("results", "01_input_prep", "ldsc_corr", "ldsc_correlations.txt"),
    delim = "\t"
    ) 

```

## Loading plotting functions

```{r load-plot-func}

source(here::here("R", "plots.R"))

```

# Methods {.tabset}

## Running univariate and bivariate tests
The detection of valid and interpretable local genetic corrlation ($r_{g}$) requires the presence of sufficient local genetic signal. For this reason, a univariate test was performed as a filtering step for bivariate local $r_{g}$ analyses. Bivariate local correlations were only performed for pairs of traits which both exhibited a significant univariate local genetic signal (p < 0.05/`r nrow(loci)`, where the denominator represents the total number of tested loci). This resulted in a total of **`r nrow(results$bivar)`** bivariate tests spanning **`r results$bivar %>% .[["locus"]] %>% unique() %>% length()`** distinct loci. 
<br><br>

# Results {.tabset}

## Tabular results {.tabset}

### Global correlations
```{r global-corr-table}

print("Global correlation column descriptions:")

tibble(
  column = colnames(global),
  description = 
    c(
      "Phenotype 1",
      "Phenotype 2",
      "The estimated genetic correlation",
      "The bootstrap standard error of the genetic correlation estimate",
      "The bootstrap standard error of the genetic correlation estimate",
      "P-value for genetic correlation",
      "Estimated snp-heritability of the second phenotype ",
      "Standard error of h2 for phenotype 2",
      "Single-trait LD score regression intercept for phenotype 2",
      "Standard error for single-trait LD score regression intercept for phenotype 2",
      "Estimated genetic covariance between p1 and p2",
      "Bootstrap standard error of cross-trait LD score regression intercept"
    )
) %>%
  DT::datatable(rownames = FALSE,
                options = list(scrollX = TRUE),
                class = 'white-space: nowrap')


print("Global correlation results (p < 0.05/n_tests):")

combn <-
  global$p1 %>%
  unique() %>%
  combn(m = 2) %>%
  t() %>%
  as_tibble() %>%
  dplyr::rename(
    p1 = V1,
    p2 = V2
  )

global_signif <- 
  global %>% 
  dplyr::filter(
    !p1==p2
  ) %>% 
  dplyr::inner_join(combn) %>%
  dplyr::filter(
    p < 0.05/nrow(combn)
  )

global_signif %>%
  DT::datatable(rownames = FALSE,
                options = list(scrollX = TRUE),
                class = 'white-space: nowrap')

```


### Univariate results
```{r univar-table}
print("Univariate column descriptions:")

tibble(
  column = colnames(results$univ),
  description = 
    c(
      "Locus ID",
      "Locus chromosome",
      "Locus start base pair",
      "Locus end base pair",
      "The number of SNPs within the locus",
      "The number of PCs retained within the locus",
      "Analysed phenotype",
      "Observed local heritability",
      "P-value from the univariate test (F-test for continuous, Chi-sq for binary)"
    )
) %>%
  DT::datatable(rownames = FALSE,
                options = list(scrollX = TRUE),
                class = 'white-space: nowrap')

print("Univariate results (p < 0.05/n_loci):")

results$univ <- 
  results$univ %>% 
  dplyr::mutate(
    phen = phen %>% 
      str_replace_all("[:digit:]", "") %>% 
      str_remove("\\..*") %>% 
      fct_relevel(
        fct_disease
      )
  )

results$univ %>% 
  dplyr::filter(p < 0.05/nrow(loci)) %>%   
  DT::datatable(rownames = FALSE,
                options = list(scrollX = TRUE),
                class = 'white-space: nowrap')
```

### Bivariate results
```{r bivar-table}

print("Bivariate column descriptions:")

tibble(
  column = colnames(results$bivar),
  description = 
    c(
      "Locus ID",
      "Locus chromosome",
      "Locus start base pair",
      "Locus end base pair",
      "The number of SNPs within the locus",
      "The number of PCs retained within the locus",
      "Phenotype 1",
      "Phenotype 2",
      "Standardised coefficient for the local genetic correlation",
      "Lower 95% confidence estimate for rho",
      "Upper 95% confidence estimate for rho",
      "Equivalent of taking the square of rho. Denotes the proportion of variance in genetic signal for phen1 explained by phen2 (and vice versa)",
      "Lower 95% confidence estimate for r2",
      "Upper 95% confidence estimate for r2",
      "Simulation p-values for the local genetic correlation"
    )
) %>%
  DT::datatable(rownames = FALSE,
                options = list(scrollX = TRUE),
                class = 'white-space: nowrap')

print("Bivariate results (p < 0.05/n_bivar_tests):")

results$bivar <- 
  results$bivar %>% 
  dplyr::mutate(
    phen1 = phen1 %>% 
      str_replace_all("[:digit:]", "") %>% 
      str_remove("\\..*"),
    phen2 = phen2 %>% 
      str_replace_all("[:digit:]", "") %>% 
      str_remove("\\..*")
  )

bivar_thres <- 0.05/nrow(results$bivar)

bivar_bonf <- 
  results$bivar %>% 
  dplyr::filter(p < bivar_thres)

bivar_bonf %>%
  DT::datatable(rownames = FALSE,
                options = list(scrollX = TRUE),
                class = 'white-space: nowrap')


```

## Global correlations versus bivariate tests {.tabset}

### Text
- Global cross-trait correlations revealed `r nrow(global_signif)` significant global $r_{g}$'s (Figure \@ref(fig:global-corr)). These global $r_{g}$'s are very much in line with what we expect from previous literature e.g. significant positive correlations between the three neuropsychiatric disorders (PMID: [29930110](https://pubmed.ncbi.nlm.nih.gov/29930110/)). Between neurodegenerative disorders, we only observe a significant postive $r_{g}$ between LBD and PD.
- With a Bonferroni cut-off of `r signif(bivar_thres, digits = 2) %>% format(scientific = F)`, we detect a total of `r bivar_bonf %>% nrow()` significant bivariate local $r_{g}$'s across `r bivar_bonf %>% dplyr::distinct(locus) %>% nrow()` distinct loci. 
- The phenotype with the highest number of significant bivariate local $r_{g}$'s was SCZ followed by BIP. Notably, the number of significant bivariate local $r_{g}$'s did not appear to correlate with GWAS sample size (Figure \@ref(fig:bivar-sample-size)). 
- As seen from the table below and Figure \@ref(fig:chord-diagram-rho), the phenotype pairs with the most local $r_{g}$'s were (i) BIP and SCZ and (ii) AD and PD. 

```{r bivar-correlations-bonf-phen-count}

phen_count <- 
  bivar_bonf %>% 
  dplyr::count(phen1, phen2) %>% 
  dplyr::arrange(-n)

phen_count

```

- Within neuropsychiatric disorders, all significant bivariate local $r_{g}$'s were positive (matching the overall positive global $r_{g}$), while within neurodegenerative disorders there was a mix of positive and negative local $r_{g}$'s (Figure \@ref(fig:chord-diagram-rho)).
- All three neurodegenerative disorders shared one significant local $r_{g}$ with SCZ, and also PD shared one negative local $r_{g}$ with BIP. 

### Figures

```{r global-corr, fig.cap = "Global genetic correlations between pairs of phenotypes. Significant negative and positive correlations are indicated by blue and red fill, respectively. Non-significant correlations (p >= 0.05/n_tests) have a grey fill."}

plot_global_corr(
  global_corr = global,
  n_phenotypes = 6
)

```

```{r bivar-sample-size, fig.cap = "Plot of total number of significant bivariate local genetic correlations for each phenotype across all loci versus GWAS sample size."}

bivar_bonf %>% 
  dplyr::count(phen1) %>% 
  dplyr::bind_rows(
    bivar_bonf %>% 
      dplyr::count(phen2) %>% 
      dplyr::rename(phen1 = phen2)
    ) %>% 
  dplyr::group_by(phen1) %>% 
  dplyr::summarise(
    n_bivar = sum(n)
  ) %>% 
  dplyr::inner_join(
    read_delim(
      file = file.path(here::here("results", "01_input_prep"),
                       "input.info.txt"),
      delim = "\t"
    ) %>% 
    dplyr::mutate(
      phenotype = phenotype %>% 
      str_replace_all("[:digit:]", "") %>% 
      str_remove("\\..*"),
      n_individ = cases + controls
    ),
    by = c("phen1" = "phenotype")
  ) %>% 
  ggplot(
    aes(
      x = n_bivar, 
      y = n_individ,
      colour = fct_relevel(
        phen1,
        fct_disease
      )
    )
    ) +
  geom_point() +
  scale_colour_brewer(
    palette = "BrBG",
    type = "div",
    name = "GWAS"
    ) +
  labs(
    x = "Number of significant local genetic correlations",
    y = "Sample size"
    ) +
  theme_rhr

```

```{r chord-diagram-rho, fig.height = 6, fig.cap = "Chord diagram showing the number of significant bivariate local genetic correlations (p < 0.05/n_tests) between each of the phenotypes across all loci. Positive and negative correlations are coloured red and blue, respectively."}

plot_bivar_chord_diagram(
  bivar_corr = bivar_bonf,
  fct_phen = fct_disease,
  palette = RColorBrewer::brewer.pal(n = 6, name = "BrBG")
)

```

## Signficant phenotype correlations at locus level {.tabset}

### Text
- The loci with the highest number of significant bivariate local $r_{g}$'s, locus 758 and 1719, were positioned on chromosome 4 and 11, respectively (Figure \@ref(fig:corr-plot), \@ref(fig:edge-diagram)). 
- The locus on chromosome 4 contains three protein-coding genes (*GPM6A*, *WDR17* and *SPATA4*), while the locus on chromosome 11 contains ten protein-coding genes, one of which includes *DRD2*, which encodes dopamine receptor D2. As perhaps expected, all three neuropsychiatric disorders positively correlate with one another at locus 1719. Somewhat unexpected is the significant negative correlation between LBD and SCZ at locus 1719.

```{r bivar-correlations-locus-count}

print("Top locus when Bonferroni-correcting (p < 0.05/n_bivar_tests):")

bivar_bonf %>%
  dplyr::count(locus, chr, start, stop, n_snps) %>% 
  dplyr::arrange(-n) %>% 
  dplyr::inner_join(loci %>% 
                      janitor::clean_names() %>% 
                      dplyr::rename(
                        locus = loc
                      )) %>% 
  dplyr::slice_max(order_by = n, n = 1)

```

### Figures

```{r corr-plot, fig.height=16, fig.cap = "Heatmaps showing the standardised coefficient for genetic correlation (rho) for each association within the loci with significant bivariate local genetic correlations (p < 0.05/n_tests). Significant negative and positive correlations are indicated by blue and red fill, respectively. Non-significant correlations have a grey fill."}

results$bivar %>% 
  dplyr::filter(locus %in% unique(bivar_bonf$locus)) %>% 
  dplyr::mutate(
    rho_fill = 
      case_when(
             p < bivar_thres ~ round(rho, 2)
           )
  ) %>% 
  ggplot(
    aes(
      x = phen1,
      y = phen2,
      fill = rho_fill,
      label = round(rho, 2)
    )
  ) +
  geom_tile(colour = "black") +
  geom_text(
    size = 2
    ) +
  facet_wrap(vars(locus), ncol = 5) +
  scale_fill_distiller(palette = "RdBu", direction = -1, na.value = "#cccccc", limits = c(-1, 1)) +
  theme_rhr
  
```

```{r, edge-diagram, fig.height = 14, fig.cap = "Edge diagrams for each locus showing the standardised coefficient for genetic correlation (rho) for each significant bivariate local genetic correlations (p < 0.05/n_tests). Significant negative and positive correlations are indicated by blue and red colour, respectively."}

plot_edge_diagram(
  bivar_corr = 
    bivar_bonf,
  phen = fct_disease,
  ncol = 3
)

```

```{r individual-locus-plots, message = F, fig.height = 8}

ref <- import("/data/references/ensembl/gtf_gff3/v87/Homo_sapiens.GRCh37.87.gtf")
ref <- ref %>% keepSeqlevels(c(1:22), pruning.mode = "coarse") 
ref <- ref[ref$type == "gene"]

loci_gr <-
  bivar_bonf %>%
  dplyr::count(locus, chr, start, stop, n_snps) %>%
  dplyr::arrange(locus) %>% 
  GenomicRanges::makeGRangesFromDataFrame(
    .,
    keep.extra.columns = TRUE,
    ignore.strand = TRUE,
    seqinfo = NULL,
    seqnames.field = "chr",
    start.field = "start",
    end.field = "stop"
  )

fig_list = vector(mode = "list", length = length(loci_gr))

for(i in 1:length(loci_gr)){
  
  fig_list[[i]] <- 
    plot_locus(
    locus_gr = loci_gr[i], 
    ref = ref
    )
  
  names(fig_list)[i] <- str_c("locus_", loci_gr[i]$locus)
  
}

fig_list


```

<br><br>

# Session info

```{r reproducibility, echo = FALSE}
# Session info
library("sessioninfo")
options(width = 120)
session_info()
```
